{"version":3,"file":"uploader.min.js","sources":["../../../../../resources/assets/js/src/ImagePaster.js","../../../../../resources/assets/uploader/js/uploader.js"],"names":["ImagePaster","url","this","pasteCatcher","init","prototype","self","document","createElement","setAttribute","id","body","appendChild","focus","addEventListener","event","onPaste","$","on","e","which","ctrlKey","metaKey","trigger","clipboardData","done","window","msConvertURL","fileList","files","length","i","blob","uploadBlob","items","text","getData","uploadText","clearPasteCatcher","type","indexOf","getAsFile","setTimeout","checkPasteCatcher","innerHTML","child","childNodes","tagName","src","onFail","uploadImage","href","reader","FileReader","onload","evt","target","result","readAsDataURL","console","log","upload","base64","format","data","ajax","timeout","error","jqXHR","textStatus","message","responseJSON","errorType","status","statusText","success","res","image","validateURL","regex","RegExp","test","host","opener","frames","location","hash","substring","title","xDomainError","setApp","browserHostError","alert","preventDefault","addClass","removeClass","css","sendData","close","urls"],"mappings":"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","sourcesContent":["var ImagePaster = function(url) {\n\n    this.url = url;\n    this.pasteCatcher = null;\n    this.init();\n\n};\n\nImagePaster.prototype.init = function() {\n\n    var self = this;\n\n    /**\n     * Firefox allows images to be pasted into contenteditable elements.\n     * So create one of those on the page and make it have focus,\n     * so paste events happen into that\n     */\n\n    // Create paste catcher element\n    self.pasteCatcher = document.createElement('div');\n    self.pasteCatcher.setAttribute('contenteditable', '');\n    self.pasteCatcher.id = 'paste-catcher';\n    document.body.appendChild(self.pasteCatcher);\n    self.pasteCatcher.focus();\n\n\n    // Listen for the 'paste' event on the body\n    //if (browserName == 'IE') {\n        //$('body').on('paste', function(event) { self.onPaste(event); });\n    //} else {\n        document.addEventListener('paste', function(event) {\n            self.onPaste(event);\n        });\n    //}\n\n    // Watch for ctrl + v being pressed\n    $(document).on('keydown',function(e) {\n        // 86 = v\n        if (e.which == 86 && (e.ctrlKey || e.metaKey)) {\n            $(document).trigger('ctrlVPressed');\n        }\n    });\n\n    // Focus paste catcher when cmd or ctrlv is pressed\n    $(document).on('ctrlVPressed', function(e) {\n        self.pasteCatcher.focus();\n    });\n\n};\n\nImagePaster.prototype.onPaste = function(event) {\n\n    var self = this;\n    var done = false;\n    var clipboardData;\n\n    if (event.clipboardData) {\n        // Chrome\n        clipboardData = event.clipboardData;\n    } else if (window.clipboardData) {\n        // IE\n        clipboardData = window.clipboardData;\n    } else {\n        // Firefox\n        //setTimeout(this.checkPasteCatcher, 1);\n    }\n\n    // IE\n    if (event.msConvertURL) {\n        var fileList = clipboardData.files;\n        if (fileList.length > 0) {\n            for (var i = 0; i < fileList.length; i++) {\n                var blob = fileList[i];\n                self.uploadBlob(blob);\n                done = true;\n            }\n        }\n    }\n\n    // Check if there is something in the paste event itself\n    if (clipboardData && clipboardData.items) {\n\n        // If there was some text on the clipboard,\n        // it might be a URL. Try and paste that...\n        if ((text = clipboardData.getData(\"text/plain\"))) {\n            self.uploadText(text);\n            self.clearPasteCatcher();\n            return;\n        }\n\n        // Loop through all the clipboardData\n        for (var i = 0; i < clipboardData.items.length; i++) {\n\n            //If this clipboard item claims to be an image, upload it\n            if (clipboardData.items[i].type.indexOf('image') !== -1) {\n                var blob = clipboardData.items[i].getAsFile();\n                self.uploadBlob(blob);\n                done = true;\n            }\n\n        }\n    }\n\n    // If there was nothing found in the clipboard data,\n    // fall back to checking if there's anything in the editable element\n    if (done) {\n        self.clearPasteCatcher();\n    } else {\n        setTimeout(function() {\n            self.checkPasteCatcher();\n        }, 1);\n    }\n};\n\n/**\n * Check if anything has been pasted into the paste catcher element\n * (Firefox + Safari?)\n */\nImagePaster.prototype.checkPasteCatcher = function() {\n\n    var text = this.pasteCatcher.innerHTML;\n    var child = this.pasteCatcher.childNodes[0];\n\n    if (child) {\n        if (child.tagName === 'IMG')\n        {\n            if (child.src.indexOf('webkit-fake-url://') != -1) {\n                this.onFail('Sorry, Safari does not currently support pasting images.');\n                return false;\n            }\n\n            this.uploadImage(child.src);\n\n        } else if (child.tagName === 'A') {\n\n            this.uploadText(child.href);\n\n        } else {\n            this.uploadText(text);\n        }\n    }\n\n    this.clearPasteCatcher();\n};\n\nImagePaster.prototype.clearPasteCatcher = function() {\n    var self = this;\n    setTimeout(function() {\n        self.pasteCatcher.innerHTML = '';\n    }, 1);\n};\n\nImagePaster.prototype.uploadBlob = function(blob) {\n    if (blob) {\n        var self = this;\n        reader = new FileReader();\n        reader.onload = function(evt) {\n            self.uploadImage(evt.target.result);\n        };\n        reader.readAsDataURL(blob);\n    }\n};\n\nImagePaster.prototype.uploadText = function(text) {\n    console.log('uploadText', text);\n    return this.upload('text', text);\n\n    /*if (this.validateURL(url)) {\n        upload('url', url);\n    } else {\n        failedUpload(\"Can't upload that. Try pasting an image or URL.\");\n    }*/\n};\n\nImagePaster.prototype.uploadImage = function(base64) {\n    return this.upload('uploadImage', base64);\n\n    /*convertImageToJpeg(base64, function(jpegBase64){\n        upload('base64', jpegBase64);\n    });*/\n};\n\n/*ImagePaster.prototype.convertImageToJpeg = function(base64, callback)\n{\n    //Convert image to a JPG so it's faster to upload\n    var img = new Image();\n    img.onload = function()\n    {\n        var canvas = convertImageToCanvas(this);\n        var data = canvas.toDataURL('image/jpeg' , 0.8);\n        callback(data);\n    };\n    img.src = base64;\n};*/\n\n/*ImagePaster.prototype.convertImageToCanvas = function(image)\n{\n    var canvas = document.createElement(\"canvas\");\n    canvas.width = image.width;\n    canvas.height = image.height;\n\n    var context = canvas.getContext(\"2d\");\n    context.fillStyle = \"#ffffff\";\n    context.fillRect(0,0,image.width,image.height);\n    context.drawImage(image, 0, 0);\n\n    return canvas;\n};*/\n\nImagePaster.prototype.upload = function(format, data) {\n\n    var self = this;\n    $(document).trigger('ctrlvuploadstart');\n\n    $.ajax({\n        url: this.url,\n        timeout: 90000,\n        type: 'POST',\n        data:{\n            format: format,\n            base64: data,\n        },\n        error: function(jqXHR, textStatus)\n        {\n            // Turn this crappy error message into something useful\n            var message = textStatus;\n            switch (textStatus) {\n                case 'timeout':\n                    message = 'The image took too long to upload';\n                    break;\n                case 'error':\n\n                    if (jqXHR.responseJSON && jqXHR.responseJSON.message) {\n                        message = 'CtrlV server error (' +  jqXHR.responseJSON.errorType + ' ' +  jqXHR.responseJSON.message +')';\n                    } else if (jqXHR.status !== 0) {\n                        message = 'CtrlV server error (' + jqXHR.status + ' ' + jqXHR.statusText +')';\n                    } else {\n                        message = 'Can\\'t connect to the CtrlV server';\n                    }\n                    break;\n                case 'abort':\n                    message = 'The upload was cancelled';\n                    break;\n                case 'parsererror':\n                    message = 'Error uploading: couldn\\'t decode the response from the server';\n                    break;\n            }\n\n            self.onFail(message);\n        },\n        success: function(res) {\n\n            if (res.image) {\n                $(document).trigger({\n                    type: 'ctrlvuploadcomplete',\n                    image: res.image\n                });\n            } else {\n                self.onFail(res.message);\n            }\n\n        },\n    });\n};\n\nImagePaster.prototype.onFail = function(message) {\n    $(document).trigger({\n        type: 'ctrlvuploaderror',\n        message: message ? message : false\n    });\n};\n\nImagePaster.prototype.validateURL = function(text) {\n    var regex = new RegExp(\"^(http|https|ftp)\\://([a-zA-Z0-9\\.\\-]+(\\:[a-zA-Z0-9\\.&amp;%\\$\\-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9\\-]+\\.)*[a-zA-Z0-9\\-]+\\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(\\:[0-9]+)*(/($|[a-zA-Z0-9\\.\\,\\?\\'\\\\\\+&amp;%\\$#\\=~_\\-]+))*$\");\n    return regex.test(text);\n};\n","var host;\nif (window.opener && window.opener.frames) {\n    /**\n     * easyXDM Magic\n     */\n    var target = location.hash.substring(9);\n    target = 'easyXDM_' + target + '_provider';\n    var host = window.opener.frames[target];\n    if (window.opener) {\n        try {\n            // test if we have access to the document\n            if (window.opener.document.title) {\n                host = window.opener;\n            }\n        } catch (xDomainError) {\n            // we have an opener, but it's not on our domain,\n            host = window.opener.frames[target];\n        }\n\n        if (host) {\n            try {\n                host.setApp(window);\n            } catch (browserHostError) {\n                alert(\"was unable to gain a reference to the iframe\");\n            }\n        }\n    }\n}\n\n/**\n * Now stuff we actually understand\n */\nvar image = null;\n\n$(document).on('click', '.restart-btn', function(e){\n    e.preventDefault();\n    $('.upload-status').addClass('out');\n    $('#upload-waiting').removeClass('out');\n    $('#container').css('background-image','');\n    image = null;\n});\n\n$(document).on('click', '.accept-btn', function(e){\n    e.preventDefault();\n    if (host) {\n        host.sendData({image: image});\n        setTimeout(function(){\n            window.close();\n        }, 500);\n    }\n});\n\n$(document).on('ctrlvuploadstart', function(){\n    $('.upload-status').addClass('out');\n    $('#upload-loading').removeClass('out');\n});\n\n$(document).on('ctrlvuploadcomplete', function(e){\n    $('.upload-status').addClass('out');\n    $('#upload-complete').removeClass('out');\n    image = e.image;\n    $('#container').css('background-image','url(' + e.image.urls.image + ')');\n});\n\n$(document).on('ctrlvuploaderror', function(e){\n    $('.upload-status').addClass('out');\n    $('#upload-error').removeClass('out');\n    $('#upload-error p').text(e.message);\n});\n\n\n\n$(document).on('keyup', function(e) {\n    // Highlighting keys when pressing\n    if (e.which == 91) { // cmd\n        $('.kbd-cmd').removeClass('pressed');\n    } else if (e.which == 17) { // ctrlv\n        $('.kbd-ctrlv').removeClass('pressed');\n    } else if (e.which == 86) { // v\n        $('.kbd-v').removeClass('pressed');\n    }\n});\n\n$(document).on('keydown', function(e) {\n    // Highlighting keys when pressing\n    if (e.which == 91) { // cmd\n        $('.kbd-cmd').addClass('pressed');\n    } else if (e.which == 17) { // ctrlv\n        $('.kbd-ctrlv').addClass('pressed');\n    } else if (e.which == 86) { // v\n        $('.kbd-v').addClass('pressed');\n    }\n});\n"]}