{"version":3,"file":"uploader.min.js","sources":["../../../../../resources/assets/lib/ImagePaster.js","../../../../../resources/assets/uploader/js/uploader.js"],"names":["ImagePaster","url","this","debug","pasteCatcher","init","prototype","log","data","extra","console","self","document","createElement","setAttribute","id","body","appendChild","focus","addEventListener","event","onPaste","$","on","e","which","ctrlKey","metaKey","trigger","clipboardData","done","JSON","stringify","window","msConvertURL","fileList","files","length","i","uploadBlob","items","text","getData","uploadText","clearPasteCatcher","x","type","indexOf","getAsFile","setTimeout","checkPasteCatcher","innerHTML","child","childNodes","tagName","src","onFail","uploadImage","href","blob","reader","FileReader","onload","evt","target","result","readAsDataURL","upload","base64","format","ajax","timeout","error","jqXHR","textStatus","message","responseJSON","errorType","status","statusText","success","res","image","validateURL","regex","RegExp","test","host","opener","frames","location","hash","substring","title","xDomainError","setApp","browserHostError","alert","preventDefault","addClass","removeClass","css","sendData","close","viewUrl","imageUrl","attr","find"],"mappings":"AAAA,GAAIA,aAAc,SAASC,KACvBC,KAAKC,OAAQ,EACbD,KAAKD,IAAMA,IACXC,KAAKE,aAAe,KACpBF,KAAKG,OAGTL,aAAYM,UAAUC,IAAM,SAASC,KAAMC,OACnCP,KAAKC,OACLO,QAAQH,IAAIC,KAAMC,QAI1BT,YAAYM,UAAUD,KAAO,WAEzB,GAAIM,MAAOT,IASXS,MAAKP,aAAeQ,SAASC,cAAc,OAC3CF,KAAKP,aAAaU,aAAa,kBAAmB,IAClDH,KAAKP,aAAaW,GAAK,gBACvBH,SAASI,KAAKC,YAAYN,KAAKP,cAC/BO,KAAKP,aAAac,QAMdN,SAASO,iBAAiB,QAAS,SAASC,OACxCT,KAAKU,QAAQD,SAKrBE,EAAEV,UAAUW,GAAG,UAAU,SAASC,GAEf,IAAXA,EAAEC,QAAgBD,EAAEE,SAAWF,EAAEG,UACjCL,EAAEV,UAAUgB,QAAQ,kBAK5BN,EAAEV,UAAUW,GAAG,eAAgB,SAASC,GACpCb,KAAKP,aAAac,WAK1BlB,YAAYM,UAAUe,QAAU,SAASD,OAErC,GAEIS,eAFAlB,KAAOT,KACP4B,MAAO,CAiBX,IAdAnB,KAAKJ,IAAI,UAAWwB,KAAKC,UAAUZ,QAE/BA,MAAMS,cAENA,cAAgBT,MAAMS,cACfI,OAAOJ,gBAEdA,cAAgBI,OAAOJ,eAOvBT,MAAMc,aAAc,CACpB,GAAIC,UAAWN,cAAcO,KAC7B,IAAID,SAASE,OAAS,EAClB,IAAK,GAAIC,GAAI,EAAGA,EAAIH,SAASE,OAAQC,IACjC3B,KAAK4B,WAAWJ,SAASG,IACzBR,MAAO,EAMnB,GAAID,eAAiBA,cAAcW,MAAO,CAEtC,GAAIC,KAGJ,IAAKA,KAAOZ,cAAca,QAAQ,cAG9B,MAFA/B,MAAKgC,WAAWF,UAChB9B,MAAKiC,mBAKT,KAAK,GAAIC,GAAI,EAAGA,EAAIhB,cAAcW,MAAMH,OAAQQ,IAES,KAAjDhB,cAAcW,MAAMK,GAAGC,KAAKC,QAAQ,WACpCpC,KAAK4B,WAAWV,cAAcW,MAAMK,GAAGG,aACvClB,MAAO,GAOfA,KACAnB,KAAKiC,oBAELK,WACI,WACItC,KAAKuC,qBAET,KASZlD,YAAYM,UAAU4C,kBAAoB,WAEtC,GAAIT,MAAOvC,KAAKE,aAAa+C,UACzBC,MAAQlD,KAAKE,aAAaiD,WAAW,EAEzC,IAAID,MACA,GAAqB,OAAjBA,MAAME,QACV,CACI,GAA+C,IAA3CF,MAAMG,IAAIR,QAAQ,sBAElB,MADA7C,MAAKsD,OAAO,6DACL,CAEXtD,MAAKuD,YAAYL,MAAMG,SACE,MAAlBH,MAAME,QACbpD,KAAKyC,WAAWS,MAAMM,MAEtBxD,KAAKyC,WAAWF,KAIxBvC,MAAK0C,qBAGT5C,YAAYM,UAAUsC,kBAAoB,WACtC,GAAIjC,MAAOT,IACX+C,YACI,WACItC,KAAKP,aAAa+C,UAAY,IAElC,IAIRnD,YAAYM,UAAUiC,WAAa,SAASoB,MACxC,GAAIA,KAAM,CACN,GAAIhD,MAAOT,KACP0D,OAAS,GAAIC,WACjBD,QAAOE,OAAS,SAASC,KACrBpD,KAAK8C,YAAYM,IAAIC,OAAOC,SAEhCL,OAAOM,cAAcP,QAI7B3D,YAAYM,UAAUqC,WAAa,SAASF,MAExC,MADA/B,SAAQH,IAAI,aAAckC,MACnBvC,KAAKiE,OAAO,OAAQ1B,OAS/BzC,YAAYM,UAAUmD,YAAc,SAASW,QACzC,MAAOlE,MAAKiE,OAAO,cAAeC,SAkCtCpE,YAAYM,UAAU6D,OAAS,SAASE,OAAQ7D,MAE5C,GAAIG,MAAOT,IACXoB,GAAEV,UAAUgB,QAAQ,oBAEpBN,EAAEgD,MACErE,IAAKC,KAAKD,IACVsE,QAAS,IACTzB,KAAM,OACNtC,MACI6D,OAAQA,OACRD,OAAQ5D,MAEZgE,MAAO,SAASC,MAAOC,YAGnB,GAAIC,QACJ,QAAQD,YACJ,IAAK,UACDC,QAAU,mCACV,MACJ,KAAK,QAGGA,QADAF,MAAMG,cAAgBH,MAAMG,aAAaD,QAC/B,uBAA0BF,MAAMG,aAAaC,UAAY,IAAOJ,MAAMG,aAAaD,QAAS,IAC9E,IAAjBF,MAAMK,OACH,uBAAyBL,MAAMK,OAAS,IAAML,MAAMM,WAAY,IAEhE,mCAEd,MACJ,KAAK,QACDJ,QAAU,0BACV,MACJ,KAAK,cACDA,QAAU,+DACV,MACJ,SACIA,QAAUD,WAIlB/D,KAAK6C,OAAOmB,UAEhBK,QAAS,SAASC,KACVA,IAAIC,MACJ5D,EAAEV,UAAUgB,SACRkB,KAAM,sBACNoC,MAAOD,IAAIC,QAGfvE,KAAK6C,OAAOyB,IAAIN,aAMhC3E,YAAYM,UAAUkD,OAAS,SAASmB,SACpCrD,EAAEV,UAAUgB,SACRkB,KAAM,mBACN6B,QAASA,QAAUA,SAAU,KAIrC3E,YAAYM,UAAU6E,YAAc,SAAS1C,MACzC,GAAI2C,OAAQ,GAAIC,QAAO,keACvB,OAAOD,OAAME,KAAK7C,MCxRtB,IAAI8C,KACJ,IAAItD,OAAOuD,QAAUvD,OAAOuD,OAAOC,OAAOpD,OAAS,EAAG,CAIlD,GAAI2B,QAAS0B,SAASC,KAAKC,UAAU,EAGrC,IAFA5B,OAAS,WAAaA,OAAS,YAC/BuB,KAAOtD,OAAOuD,OAAOC,OAAOzB,QACxB/B,OAAOuD,OAAQ,CACf,IAEQvD,OAAOuD,OAAO5E,SAASiF,QACvBN,KAAOtD,OAAOuD,QAEpB,MAAOM,cAELP,KAAOtD,OAAOuD,OAAOC,OAAOzB,QAGhC,GAAIuB,KACA,IACIA,KAAKQ,OAAO9D,QACd,MAAO+D,kBACLC,MAAM,kDAStB,GAAIf,OAAQ,IAEZ5D,GAAEV,UAAUW,GAAG,QAAS,eAAgB,SAASC,GAC7CA,EAAE0E,iBACF5E,EAAE,kBAAkB6E,SAAS,OAC7B7E,EAAE,mBAAmB8E,YAAY,OACjC9E,EAAE,cAAc+E,IAAI,mBAAmB,IACvCnB,MAAQ,OAGZ5D,EAAEV,UAAUW,GAAG,QAAS,cAAe,SAASC,GAC5CA,EAAE0E,iBACEX,OACAA,KAAKe,UAAUpB,MAAOA,QACtBjC,WAAW,WACPhB,OAAOsE,SACR,QAIXjF,EAAEV,UAAUW,GAAG,mBAAoB,WAC/BD,EAAE,kBAAkB6E,SAAS,OAC7B7E,EAAE,mBAAmB8E,YAAY,SAGrC9E,EAAEV,UAAUW,GAAG,sBAAuB,SAASC,GAC3CF,EAAE,kBAAkB6E,SAAS,OAC7B7E,EAAE,oBAAoB8E,YAAY,MAClC,IAAII,SAAUhF,EAAE0D,MAAMjF,IAClBwG,SAAWjF,EAAE0D,MAAMA,MAAMjF,GAC7BqB,GAAE,aAAaoF,KAAK,OAAQF,SAC5BlF,EAAE,cAAc+E,IAAI,mBAAmB,OAASI,SAAW,OAG/DnF,EAAEV,UAAUW,GAAG,mBAAoB,SAASC,GACxCF,EAAE,kBAAkB6E,SAAS,OAC7B7E,EAAE,iBAAiB8E,YAAY,OAAOO,KAAK,KAAKlE,KAAKjB,EAAEmD,WAG3DrD,EAAEV,UAAUW,GAAG,QAAS,SAASC,GAEd,IAAXA,EAAEC,OAA2B,MAAZD,EAAEC,MACnBH,EAAE,YAAY8E,YAAY,WACR,IAAX5E,EAAEC,MACTH,EAAE,aAAa8E,YAAY,WACT,IAAX5E,EAAEC,OACTH,EAAE,UAAU8E,YAAY,aAIhC9E,EAAEV,UAAUW,GAAG,UAAW,SAASC,GAE/Bd,QAAQH,IAAIiB,GAGG,IAAXA,EAAEC,OAA2B,MAAZD,EAAEC,MACnBH,EAAE,YAAY6E,SAAS,WACL,IAAX3E,EAAEC,MACTH,EAAE,aAAa6E,SAAS,WACN,IAAX3E,EAAEC,OACTH,EAAE,UAAU6E,SAAS","sourcesContent":["var ImagePaster = function(url) {\n    this.debug = true;\n    this.url = url;\n    this.pasteCatcher = null;\n    this.init();\n};\n\nImagePaster.prototype.log = function(data, extra) {\n    if (this.debug) {\n        console.log(data, extra);\n    }\n};\n\nImagePaster.prototype.init = function() {\n\n    var self = this;\n\n    /**\n     * Firefox allows images to be pasted into contenteditable elements.\n     * So create one of those on the page and make it have focus,\n     * so paste events happen into that\n     */\n\n    // Create paste catcher element\n    self.pasteCatcher = document.createElement('div');\n    self.pasteCatcher.setAttribute('contenteditable', '');\n    self.pasteCatcher.id = 'paste-catcher';\n    document.body.appendChild(self.pasteCatcher);\n    self.pasteCatcher.focus();\n\n    // Listen for the 'paste' event on the body\n    //if (browserName == 'IE') {\n        //$('body').on('paste', function(event) { self.onPaste(event); });\n    //} else {\n        document.addEventListener('paste', function(event) {\n            self.onPaste(event);\n        });\n    //}\n\n    // Watch for ctrl + v being pressed\n    $(document).on('keydown',function(e) {\n        // 86 = v\n        if (e.which == 86 && (e.ctrlKey || e.metaKey)) {\n            $(document).trigger('ctrlVPressed');\n        }\n    });\n\n    // Focus paste catcher when cmd or ctrlv is pressed\n    $(document).on('ctrlVPressed', function(e) {\n        self.pasteCatcher.focus();\n    });\n\n};\n\nImagePaster.prototype.onPaste = function(event) {\n\n    var self = this;\n    var done = false;\n    var clipboardData;\n\n    self.log('onPaste', JSON.stringify(event));\n\n    if (event.clipboardData) {\n        // Chrome\n        clipboardData = event.clipboardData;\n    } else if (window.clipboardData) {\n        // IE\n        clipboardData = window.clipboardData;\n    } else {\n        // Firefox\n        //setTimeout(this.checkPasteCatcher, 1);\n    }\n\n    // IE\n    if (event.msConvertURL) {\n        var fileList = clipboardData.files;\n        if (fileList.length > 0) {\n            for (var i = 0; i < fileList.length; i++) {\n                self.uploadBlob(fileList[i]);\n                done = true;\n            }\n        }\n    }\n\n    // Check if there is something in the paste event itself\n    if (clipboardData && clipboardData.items) {\n\n        var text;\n        // If there was some text on the clipboard,\n        // it might be a URL. Try and paste that...\n        if ((text = clipboardData.getData(\"text/plain\"))) {\n            self.uploadText(text);\n            self.clearPasteCatcher();\n            return;\n        }\n\n        // Loop through all the clipboardData\n        for (var x = 0; x < clipboardData.items.length; x++) {\n            // If this clipboard item claims to be an image, upload it\n            if (clipboardData.items[x].type.indexOf('image') !== -1) {\n                self.uploadBlob(clipboardData.items[x].getAsFile());\n                done = true;\n            }\n        }\n    }\n\n    // If there was nothing found in the clipboard data\n    // fall back to checking if there's anything in the editable element\n    if (done) {\n        self.clearPasteCatcher();\n    } else {\n        setTimeout(\n            function() {\n                self.checkPasteCatcher();\n            },\n            10\n        );\n    }\n};\n\n/**\n * Check if anything has been pasted into the paste catcher element\n * (Firefox + Safari?)\n */\nImagePaster.prototype.checkPasteCatcher = function() {\n\n    var text = this.pasteCatcher.innerHTML;\n    var child = this.pasteCatcher.childNodes[0];\n\n    if (child) {\n        if (child.tagName == 'IMG')\n        {\n            if (child.src.indexOf('webkit-fake-url://') != -1) {\n                this.onFail('Sorry, Safari does not currently support pasting images.');\n                return false;\n            }\n            this.uploadImage(child.src);\n        } else if (child.tagName === 'A') {\n            this.uploadText(child.href);\n        } else {\n            this.uploadText(text);\n        }\n    }\n\n    this.clearPasteCatcher();\n};\n\nImagePaster.prototype.clearPasteCatcher = function() {\n    var self = this;\n    setTimeout(\n        function() {\n            self.pasteCatcher.innerHTML = '';\n        },\n        1\n    );\n};\n\nImagePaster.prototype.uploadBlob = function(blob) {\n    if (blob) {\n        var self = this;\n        var reader = new FileReader();\n        reader.onload = function(evt) {\n            self.uploadImage(evt.target.result);\n        };\n        reader.readAsDataURL(blob);\n    }\n};\n\nImagePaster.prototype.uploadText = function(text) {\n    console.log('uploadText', text);\n    return this.upload('text', text);\n\n    /*if (this.validateURL(url)) {\n        upload('url', url);\n    } else {\n        failedUpload(\"Can't upload that. Try pasting an image or URL.\");\n    }*/\n};\n\nImagePaster.prototype.uploadImage = function(base64) {\n    return this.upload('uploadImage', base64);\n\n    /*convertImageToJpeg(base64, function(jpegBase64){\n        upload('base64', jpegBase64);\n    });*/\n};\n\n/*ImagePaster.prototype.convertImageToJpeg = function(base64, callback)\n{\n    //Convert image to a JPG so it's faster to upload\n    var img = new Image();\n    img.onload = function()\n    {\n        var canvas = convertImageToCanvas(this);\n        var data = canvas.toDataURL('image/jpeg' , 0.8);\n        callback(data);\n    };\n    img.src = base64;\n};*/\n\n/*ImagePaster.prototype.convertImageToCanvas = function(image)\n{\n    var canvas = document.createElement(\"canvas\");\n    canvas.width = image.width;\n    canvas.height = image.height;\n\n    var context = canvas.getContext(\"2d\");\n    context.fillStyle = \"#ffffff\";\n    context.fillRect(0,0,image.width,image.height);\n    context.drawImage(image, 0, 0);\n\n    return canvas;\n};*/\n\nImagePaster.prototype.upload = function(format, data) {\n\n    var self = this;\n    $(document).trigger('ctrlvuploadstart');\n\n    $.ajax({\n        url: this.url,\n        timeout: 90000,\n        type: 'POST',\n        data:{\n            format: format,\n            base64: data\n        },\n        error: function(jqXHR, textStatus)\n        {\n            // Turn this error message into something useful\n            var message;\n            switch (textStatus) {\n                case 'timeout':\n                    message = 'The image took too long to upload';\n                    break;\n                case 'error':\n\n                    if (jqXHR.responseJSON && jqXHR.responseJSON.message) {\n                        message = 'CtrlV server error (' +  jqXHR.responseJSON.errorType + ' ' +  jqXHR.responseJSON.message +')';\n                    } else if (jqXHR.status !== 0) {\n                        message = 'CtrlV server error (' + jqXHR.status + ' ' + jqXHR.statusText +')';\n                    } else {\n                        message = 'Can\\'t connect to the CtrlV server';\n                    }\n                    break;\n                case 'abort':\n                    message = 'The upload was cancelled';\n                    break;\n                case 'parsererror':\n                    message = 'Error uploading: couldn\\'t decode the response from the server';\n                    break;\n                default:\n                    message = textStatus;\n                    break;\n            }\n\n            self.onFail(message);\n        },\n        success: function(res) {\n            if (res.image) {\n                $(document).trigger({\n                    type: 'ctrlvuploadcomplete',\n                    image: res.image\n                });\n            } else {\n                self.onFail(res.message);\n            }\n        }\n    });\n};\n\nImagePaster.prototype.onFail = function(message) {\n    $(document).trigger({\n        type: 'ctrlvuploaderror',\n        message: message ? message : false\n    });\n};\n\nImagePaster.prototype.validateURL = function(text) {\n    var regex = new RegExp(\"^(http|https|ftp)\\://([a-zA-Z0-9\\.\\-]+(\\:[a-zA-Z0-9\\.&amp;%\\$\\-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9\\-]+\\.)*[a-zA-Z0-9\\-]+\\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(\\:[0-9]+)*(/($|[a-zA-Z0-9\\.\\,\\?\\'\\\\\\+&amp;%\\$#\\=~_\\-]+))*$\");\n    return regex.test(text);\n};\n","var host;\nif (window.opener && window.opener.frames.length > 0) {\n    /**\n     * easyXDM Magic\n     */\n    var target = location.hash.substring(9);\n    target = 'easyXDM_' + target + '_provider';\n    host = window.opener.frames[target];\n    if (window.opener) {\n        try {\n            // test if we have access to the document\n            if (window.opener.document.title) {\n                host = window.opener;\n            }\n        } catch (xDomainError) {\n            // we have an opener, but it's not on our domain,\n            host = window.opener.frames[target];\n        }\n\n        if (host) {\n            try {\n                host.setApp(window);\n            } catch (browserHostError) {\n                alert(\"was unable to gain a reference to the iframe\");\n            }\n        }\n    }\n}\n\n/**\n * Now stuff we actually understand\n */\nvar image = null;\n\n$(document).on('click', '#restart-btn', function(e){\n    e.preventDefault();\n    $('.upload-status').addClass('out');\n    $('#upload-waiting').removeClass('out');\n    $('#container').css('background-image','');\n    image = null;\n});\n\n$(document).on('click', '#accept-btn', function(e){\n    e.preventDefault();\n    if (host) {\n        host.sendData({image: image});\n        setTimeout(function(){\n            window.close();\n        }, 500);\n    }\n});\n\n$(document).on('ctrlvuploadstart', function(){\n    $('.upload-status').addClass('out');\n    $('#upload-loading').removeClass('out');\n});\n\n$(document).on('ctrlvuploadcomplete', function(e){\n    $('.upload-status').addClass('out');\n    $('#upload-complete').removeClass('out');\n    var viewUrl = e.image.url;\n    var imageUrl = e.image.image.url;\n    $('#view-btn').attr('href', viewUrl);\n    $('#container').css('background-image','url(' + imageUrl + ')');\n});\n\n$(document).on('ctrlvuploaderror', function(e){\n    $('.upload-status').addClass('out');\n    $('#upload-error').removeClass('out').find('p').text(e.message);\n});\n\n$(document).on('keyup', function(e) {\n    // Highlighting keys when pressing\n    if (e.which == 91 || e.which === 224) { // cmd\n        $('.kbd-cmd').removeClass('pressed');\n    } else if (e.which == 17) { // ctrl\n        $('.kbd-ctrl').removeClass('pressed');\n    } else if (e.which == 86) { // v\n        $('.kbd-v').removeClass('pressed');\n    }\n});\n\n$(document).on('keydown', function(e) {\n\n    console.log(e);\n\n    // Highlighting keys when pressing\n    if (e.which == 91 || e.which === 224) { // cmd (91 in\n        $('.kbd-cmd').addClass('pressed');\n    } else if (e.which == 17) { // ctrl\n        $('.kbd-ctrl').addClass('pressed');\n    } else if (e.which == 86) { // v\n        $('.kbd-v').addClass('pressed');\n    }\n});\n"]}